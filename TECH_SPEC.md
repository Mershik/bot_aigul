# Техническая спецификация: AI-Тренажер для отделов продаж "Aigul"

## 1. Общее описание
Приложение представляет собой интеллектуальный тренажер на базе LLM (Large Language Models) для обучения сотрудников отделов продаж. Система имитирует поведение клиента в различных сценариях, оценивает навыки ведения переговоров и предоставляет детальную обратную связь.

---

## 2. Роли пользователей
1.  **Сотрудник (Стажер/Менеджер):**
    *   Проходит тренировочные сессии.
    *   Выбирает сценарии сложности.
    *   Получает оценку и рекомендации после завершения диалога.
2.  **Администратор (РОП/HR):**
    *   Управляет списком допущенных сотрудников (White-list).
    *   Просматривает аналитику по всем сессиям.
    *   Настраивает сценарии и системные промпты.
    *   Управляет базой знаний (RAG).

---

## 3. Функциональные возможности

### 3.1. MVP (Minimum Viable Product)
*   **Авторизация:** Доступ по Telegram ID через White-list.
*   **Выбор сценария:** Меню с предустановленными кейсами (холодный звонок, отработка возражений, закрытие сделки).
*   **Диалоговый движок:** Интерактивный чат с AI-клиентом (OpenRouter API).
*   **RAG-модуль:** Использование специфических данных о продукте и возражениях из текстовых файлов/PDF.
*   **Система оценки (Judge):** Автоматический анализ сессии по критериям:
    *   Соблюдение скрипта.
    *   Тон общения.
    *   Достижение цели (запись на встречу/продажа).
    *   Выставление итогового балла (1-10).
*   **Интеграция с Google Sheets:** Автоматизированная система отчетности, включающая:
    *   **Лист "Результаты":** Сводная таблица с ID сессии, именем сотрудника, датой, оценкой (1-10), сильными сторонами, ошибками и рекомендациями.
    *   **Лист "Диалоги":** Полные логи переписки для детального аудита РОПом.
    *   **Система перекрестных ссылок:** Использование формул `HYPERLINK` и `MATCH` для быстрого перехода между оценкой и текстом диалога.

### 3.2. Дополнительные фичи (Backlog)
*   **Голосовые тренировки:** Интеграция STT (Speech-to-Text) и TTS (Text-to-Speech) для имитации реального звонка.
*   **Личный кабинет Web:** Дашборд для РОПа с графиками прогресса сотрудников.
*   **Динамическая сложность:** AI подстраивает уровень "вредности" клиента под уровень менеджера.
*   **Мультиплатформенность:** Выход за пределы Telegram (Web-виджет, интеграция в CRM).
*   **Командные соревнования:** Рейтинги сотрудников внутри отделов.

---

## 4. Пользовательские сценарии (User Stories)

### Сценарий 1: Прохождение тренировки
1.  Сотрудник запускает бота `/start`.
2.  Выбирает сценарий "Отработка возражения 'Дорого'".
3.  Бот входит в роль клиента и пишет первое сообщение.
4.  Сотрудник отвечает. Бот (через RAG) проверяет информацию о продукте и продолжает диалог.
5.  Сотрудник завершает диалог командой `/finish` или по достижении цели.
6.  Сервис `Judge` анализирует историю сообщений.
7.  Сотрудник получает карточку с баллом, списком ошибок и советами.

### Сценарий 2: Администрирование
1.  Админ нажимает кнопку "Управление сотрудниками".
2.  Добавляет Telegram ID нового стажера.
3.  Обновляет файл `product_info.txt` в папке `knowledge_base`.
4.  Бот автоматически переиндексирует базу знаний (ChromaDB).

---

## 5. Технологический стек

### Frontend
*   **Telegram Bot API (Aiogram 3.x):** Основной интерфейс взаимодействия.
*   **React + Tailwind CSS (для будущей Web-панели):** Обеспечивает масштабируемость интерфейса администрирования.

### Backend
*   **Python 3.10+:** Основной язык разработки.
*   **FastAPI:** Для создания API (в случае перехода на Web) и интеграций.
*   **SQLAlchemy + PostgreSQL 15:** Надежное хранение данных пользователей, сессий и оценок (развернуто в Docker).
*   **Aiohttp:** Асинхронные запросы к LLM провайдерам.

### AI & Data
*   **OpenRouter (Gemini / Claude 3.5 Sonnet):** "Мозги" системы для генерации ответов и оценки.
*   **ChromaDB:** Векторная база данных для реализации RAG (локальное хранение).
*   **Sentence-Transformers:** Локальная генерация эмбеддингов (модель `all-MiniLM-L6-v2`).
*   **Google Sheets API:** Для внешней аналитики и отчетности.

### Инфраструктура и DevOps
*   **VPS:** Виртуальный сервер (рекомендуется зарубежная локация для стабильного доступа к OpenRouter API).
*   **Docker & Docker Compose:** Контейнеризация всех компонентов (Бот, PostgreSQL, ChromaDB).
*   **Environment Variables (.env):** Защита API ключей и доступов.
*   **Logging:** Мониторинг ошибок и действий пользователей.

### Система отчетности и аналитики (Google Sheets API)
Для обеспечения прозрачности обучения реализована двухуровневая система логирования через `gspread-asyncio`:

1.  **Структура данных (Лист "Результаты"):**
    *   `ID Сессии`: Уникальный идентификатор для связи с логами.
    *   `Сотрудник`: Имя и Telegram ID.
    *   `Метрики`: Длительность (мин), количество сообщений, итоговый балл.
    *   `Качественный анализ`: Текстовые поля с перечислением плюсов, ошибок и советов от AI-судьи.
    *   `Интерактивность`: Столбец "Ссылка" с формулой для мгновенного перехода к логу конкретного диалога.

2.  **Архивация диалогов (Лист "Диалоги"):**
    *   Хранение полной истории сообщений в одной ячейке (форматированный текст).
    *   Обратная ссылка на лист результатов для быстрого возврата к оценке.

3.  **Техническая реализация:**
    *   **Асинхронность:** Запись в таблицу происходит в фоновом режиме, не блокируя интерфейс бота для пользователя.
    *   **Service Account:** Использование Google Service Account с ограниченным доступом только к конкретной таблице по `GOOGLE_SHEETS_ID`.

### Логика усложнения диалога (Dynamic Difficulty)
Для обеспечения эффективного обучения система использует многоуровневую логику изменения поведения AI-клиента в зависимости от прогресса сессии:

1.  **Фазовое поведение (Phase-based Logic):**
    *   **Начальная фаза (1-5 сообщений):** Клиент проявляет умеренный интерес, но высказывает базовые сомнения. Задача менеджера — установить контакт и выявить потребность.
    *   **Фаза сопротивления (6-12 сообщений):** AI активирует "режим сравнения". Начинает приводить аргументы конкурентов, ссылаться на негативный опыт или требовать нереальные скидки.
    *   **Критическая фаза (13+ сообщений):** Клиент становится "торопливым" или "жестким". Если менеджер не перешел к закрытию или не отработал ключевые боли, AI завершает диалог отказом.

2.  **Триггеры сложности:**
    *   **Проверка фактов:** Если менеджер ошибается в ценах или условиях (на основе данных из RAG), AI мгновенно "ловит" его на ошибке, что снижает уровень доверия и усложняет дальнейшее убеждение.
    *   **Эмоциональный окрас:** Модель анализирует тон менеджера. На излишнюю настойчивость AI отвечает агрессией или закрытостью, на неуверенность — доминированием в диалоге.

3.  **Условия завершения (Win/Loss Conditions):**
    *   **Победа:** Достигается при выполнении целевого действия (согласие на встречу/сделку), прописанного в системном промпте сценария.
    *   **Поражение:** Наступает при грубых фактических ошибках, превышении лимита сообщений без прогресса или при явном отказе клиента ("До свидания", "Мне не интересно").

### Детальная архитектура RAG (Retrieval-Augmented Generation)
Система RAG реализована как двухуровневый механизм извлечения знаний для обеспечения реалистичности диалога и точности оценки:

1.  **Компоненты хранилища:**
    *   **Client Collection:** Содержит информацию о продукте, услугах компании и типичных возражениях. Используется LLM в роли "Клиента" для формирования аргументированных ответов.
    *   **Scripts Collection:** Содержит эталонные скрипты продаж и лучшие практики. Используется сервисом `Judge` для сравнения действий сотрудника с идеальным сценарием.

2.  **Процесс обработки данных (Ingestion Pipeline):**
    *   **Загрузка:** Поддержка форматов `.txt` и `.pdf` из директории `knowledge_base/`.
    *   **Чанкинг (Chunking):** Разбиение документов на фрагменты по 500 символов для сохранения контекстной плотности.
    *   **Векторизация:** Генерация эмбеддингов на стороне сервера (CPU/GPU) без передачи данных внешним провайдерам на этапе индексации.

3.  **Механизм поиска (Retrieval):**
    *   **Семантический поиск:** При каждом сообщении пользователя система выполняет поиск `top_k=3` наиболее релевантных фрагментов.
    *   **Контекстная инъекция:** Найденные фрагменты встраиваются в системный промпт LLM как "актуальные знания", что минимизирует галлюцинации модели.

### DevOps & Security
*   **Docker & Docker Compose:** Контейнеризация для быстрой развертки.
*   **Environment Variables (.env):** Защита API ключей и доступов.
*   **Rate Limiting:** Защита от спама и перерасхода лимитов LLM.
*   **Logging (Loguru/Logging):** Мониторинг ошибок и действий пользователей.

---

## 6. Безопасность и масштабируемость
*   **Безопасность:** Валидация всех входящих данных, ограничение длины сообщений, использование Middleware для проверки прав доступа.
*   **Масштабируемость:** Асинхронная архитектура позволяет обрабатывать сотни одновременных диалогов. Использование векторной БД позволяет расширять базу знаний до тысяч документов без потери скорости поиска.
